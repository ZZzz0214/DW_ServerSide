# 财务系统最终功能说明

## 系统架构

### 📊 财务表 (erp_finance)
**功能**：记录日常收支明细
**影响**：操作会自动影响财务金额表的对应渠道余额

### 💰 财务金额表 (erp_finance_amount)  
**功能**：余额管理和充值记录
**特点**：每笔充值/消费都是独立记录，支持完整的资金流水追踪

## 功能设计

### 🔄 数据联动机制

#### 财务表 → 财务金额表
- **收入记录**：自动在对应渠道创建充值记录，增加余额
- **支出记录**：自动在对应渠道创建消费记录，减少余额
- **修改记录**：先回滚原余额变化，再应用新的余额变化
- **删除记录**：回滚对应的余额变化

#### 支持的渠道
- 微信
- 支付宝  
- 银行卡

### 📱 前端功能

#### 财务记录页面 (/finance/record)
- ✅ 完整的收支记录管理（增删改查）
- ✅ 操作会自动影响对应渠道余额
- ✅ 支持收入/支出类型选择
- ✅ 支持渠道选择（微信、支付宝、银行卡）

#### 财务金额页面 (/finance/amount)
- ✅ 三个渠道的余额概览卡片
- ✅ 每个渠道的充值按钮
- ✅ 完整的充值/消费记录列表
- ❌ 移除了"新增"按钮（只能通过充值按钮或财务记录影响）
- ✅ 刷新余额功能

### 🔧 操作流程

#### 场景1：日常收支记录
1. 进入"财务记录"页面
2. 新增收支记录，选择渠道和类型
3. 系统自动在财务金额表创建对应记录
4. 对应渠道余额自动更新

#### 场景2：直接充值
1. 进入"财务金额"页面
2. 点击对应渠道的"充值"按钮
3. 输入充值金额
4. 系统创建充值记录，更新余额

#### 场景3：查看余额和流水
1. 进入"财务金额"页面
2. 查看各渠道余额概览
3. 查看详细的充值/消费记录列表
4. 支持筛选和搜索功能

## 数据结构

### 财务记录表字段
- `billName`: 账单名称
- `amount`: 收支金额
- `incomeExpense`: 收支类型（1：收入，2：支出）
- `account`: 收付账号（微信、支付宝、银行卡）
- `category`: 收付类目
- `status`: 账单状态

### 财务金额记录字段
- `channelType`: 渠道类型（微信、支付宝、银行卡）
- `amount`: 操作金额
- `operationType`: 操作类型（1：充值，2：消费）
- `beforeBalance`: 操作前余额
- `afterBalance`: 操作后余额
- `remark`: 备注（财务收入、财务支出、用户充值等）

## 业务逻辑

### 余额计算
- 通过查询每个渠道的最新记录的 `afterBalance` 获得当前余额
- 累计充值通过统计所有充值记录的金额总和获得

### 事务处理
- 所有余额相关操作都使用事务保证数据一致性
- 修改/删除财务记录时会先回滚再应用新的余额变化

### 用户隔离
- 所有数据都按 `creator` 字段进行用户隔离
- 用户只能看到和操作自己的数据

## 优势特点

1. **数据一致性**：财务记录和余额变化完全同步
2. **操作便捷**：既可以通过记录影响余额，也可以直接充值
3. **审计完整**：保留所有操作的完整记录和余额变化
4. **用户友好**：清晰的界面提示和功能分离
5. **扩展性好**：支持添加新的渠道和操作类型

## 注意事项

- 财务记录的账号字段必须是"微信"、"支付宝"、"银行卡"之一
- 删除财务记录会影响余额，请谨慎操作
- 余额不足时无法创建消费记录
- 所有金额计算保留两位小数 