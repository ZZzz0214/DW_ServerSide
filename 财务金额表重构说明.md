# 财务金额表重构说明

## 问题背景

原有的财务金额表设计是将所有渠道（微信、支付宝、银行卡）的余额存储在一条记录中，每次充值都更新这条记录。这种设计有以下问题：

1. **缺乏历史记录**：无法查看每次充值/消费的详细记录
2. **数据结构不合理**：一条记录包含多个渠道信息，不符合数据库设计规范
3. **扩展性差**：新增渠道需要修改表结构
4. **审计困难**：无法追踪每笔资金的来源和去向

## 重构方案

### 1. 数据结构调整

**原有字段（已废弃但保留兼容）：**
- `wechatRecharge` - 微信充值金额
- `alipayRecharge` - 支付宝充值金额  
- `bankCardRecharge` - 银行卡充值金额
- `wechatBalance` - 微信当前余额
- `alipayBalance` - 支付宝当前余额
- `bankCardBalance` - 银行卡当前余额

**新增字段：**
- `channelType` - 渠道类型（微信、支付宝、银行卡）
- `amount` - 操作金额
- `operationType` - 操作类型（1：充值，2：消费）
- `beforeBalance` - 操作前余额
- `afterBalance` - 操作后余额

### 2. 业务逻辑变更

**原有逻辑：**
- 每个用户一条财务金额记录
- 充值时更新对应渠道的充值金额和余额字段

**新逻辑：**
- 每次充值/消费都创建一条新记录
- 余额通过计算最新记录的`afterBalance`获得
- 支持完整的资金流水记录

### 3. 前端界面调整

**列表页面变更：**
- 原来显示三个渠道的余额汇总
- 现在显示每条充值/消费记录的详细信息
- 新增渠道类型、操作类型筛选
- 新增操作前后余额显示

**表单页面变更：**
- 原来是三个渠道的余额管理表单
- 现在是单条记录的充值/消费表单
- 支持选择渠道类型和操作类型
- 自动计算操作前后余额

**余额概览：**
- 顶部卡片继续显示各渠道余额汇总
- 余额数据通过API实时计算获得

### 4. API接口变更

**新增接口：**
- `GET /erp/finance-amount/channel-balance` - 获取指定渠道余额
- 更新分页查询支持渠道类型和操作类型筛选

**业务方法调整：**
- `getUserBalanceSummary()` - 通过计算获得各渠道余额汇总
- `getChannelBalance()` - 获取指定渠道当前余额
- `createRechargeRecord()` - 创建充值记录
- `createConsumeRecord()` - 创建消费记录

### 5. 兼容性处理

为了保证系统平稳过渡，采用以下兼容性措施：

1. **数据字段兼容**：保留原有字段，标记为`@Deprecated`
2. **API兼容**：原有API继续可用，内部使用新逻辑实现
3. **数据迁移**：现有数据可以继续使用，新数据使用新结构

## 优势

### 1. 完整的审计跟踪
- 每笔资金操作都有完整记录
- 可以追踪每笔资金的来源和去向
- 支持按时间、渠道、操作类型查询

### 2. 更好的数据结构
- 符合数据库设计规范
- 易于扩展新的渠道类型
- 数据一致性更好

### 3. 更丰富的功能
- 支持充值和消费两种操作类型
- 自动计算操作前后余额
- 支持多维度数据筛选和分析

### 4. 更好的用户体验
- 直观的余额变化展示
- 清晰的操作记录列表
- 实时的余额计算

## 使用说明

### 1. 充值操作
1. 点击余额卡片上的"充值"按钮
2. 在弹窗中输入充值金额
3. 系统自动创建充值记录并更新余额

### 2. 查看记录
1. 在记录列表中可以看到所有充值/消费记录
2. 支持按渠道类型、操作类型筛选
3. 每条记录显示操作前后余额变化

### 3. 手动添加记录
1. 点击"新增"按钮
2. 选择渠道类型和操作类型
3. 输入金额和备注
4. 系统自动计算操作前后余额

## 技术实现

### 1. 后端实现
- 使用事务确保数据一致性
- 余额计算采用最新记录的`afterBalance`
- 支持并发操作的余额保护

### 2. 前端实现
- 响应式设计，支持移动端
- 实时余额计算和显示
- 优化的用户交互体验

### 3. 数据安全
- 严格的用户数据隔离
- 余额不足时的操作限制
- 完整的错误处理机制 