# ç»„å“è¡¨æœç´¢ç­–ç•¥ä¼˜åŒ–è¯´æ˜

## ä¼˜åŒ–èƒŒæ™¯

ç»„å“è¡¨çš„åˆ†é¡µæŸ¥è¯¢ä¸­ï¼Œé™¤äº†ç»„å“ç¼–å·å·²ç»å®ç°äº†ç®€åŒ–çš„æœç´¢ç­–ç•¥å¤–ï¼Œå…¶ä»–æœç´¢å­—æ®µï¼ˆäº§å“åç§°ã€äº§å“ç®€ç§°ã€å‘è´§ç¼–ç ã€é‡‡è´­äººå‘˜ã€ä¾›åº”å•†ã€åˆ›å»ºäººå‘˜ï¼‰ä»ç„¶ä½¿ç”¨å¤æ‚çš„æ™ºèƒ½åŒ¹é…ç­–ç•¥ï¼Œå¯¼è‡´æœç´¢é€»è¾‘ä¸ä¸€è‡´ä¸”æ€§èƒ½è¾ƒå·®ã€‚

## ä¼˜åŒ–ç›®æ ‡

1. **ç»Ÿä¸€æœç´¢ç­–ç•¥**ï¼šæ‰€æœ‰æœç´¢å­—æ®µéƒ½é‡‡ç”¨ä¸ç»„å“ç¼–å·ä¸€è‡´çš„ç®€åŒ–æœç´¢ç­–ç•¥
2. **æé«˜æœç´¢æ€§èƒ½**ï¼šç§»é™¤å¤æ‚çš„æ™ºèƒ½åˆ†è¯åŒ¹é…å’Œå­å­—ç¬¦ä¸²åŒ¹é…é€»è¾‘
3. **ç®€åŒ–ç»´æŠ¤**ï¼šå‡å°‘ä»£ç å¤æ‚åº¦ï¼Œæé«˜å¯ç»´æŠ¤æ€§
4. **ä¿æŒåŠŸèƒ½**ï¼šç¡®ä¿ç²¾ç¡®æŸ¥è¯¢å’Œæ¨¡ç³ŠæŸ¥è¯¢åŠŸèƒ½å®Œæ•´

## ä¼˜åŒ–å†…å®¹

### 1. æœç´¢ç­–ç•¥ç»Ÿä¸€

æ‰€æœ‰æœç´¢å­—æ®µç°åœ¨éƒ½é‡‡ç”¨ä¸‰å±‚æ ¸å¿ƒåŒ¹é…ç­–ç•¥ï¼š

```java
// ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šå®Œå…¨ç²¾ç¡®åŒ¹é…ï¼ˆæƒé‡1,000,000ï¼‰
multiMatchQuery.should(QueryBuilders.termQuery("field_keyword", value).boost(1000000.0f));

// ç¬¬äºŒä¼˜å…ˆçº§ï¼šå‰ç¼€åŒ¹é…ï¼ˆæƒé‡100,000ï¼‰
multiMatchQuery.should(QueryBuilders.prefixQuery("field_keyword", value).boost(100000.0f));

// ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šåŒ…å«åŒ¹é…ï¼ˆæƒé‡50,000ï¼‰
multiMatchQuery.should(QueryBuilders.wildcardQuery("field_keyword", "*" + value + "*").boost(50000.0f));
```

### 2. ä¼˜åŒ–çš„å­—æ®µåˆ—è¡¨

| å­—æ®µåç§° | å­—æ®µç±»å‹ | æœç´¢å­—æ®µ | ä¼˜åŒ–å‰ç­–ç•¥ | ä¼˜åŒ–åç­–ç•¥ |
|---------|---------|---------|-----------|-----------|
| ç»„å“ç¼–å· | Keyword | no_keyword | âœ… å·²ä¼˜åŒ– | ä¸‰å±‚åŒ¹é… |
| äº§å“åç§° | Text + Keyword | name_keyword | å¤æ‚æ™ºèƒ½åŒ¹é… | ä¸‰å±‚åŒ¹é… |
| äº§å“ç®€ç§° | Text + Keyword | short_name_keyword | å¤æ‚æ™ºèƒ½åŒ¹é… | ä¸‰å±‚åŒ¹é… |
| å‘è´§ç¼–ç  | Keyword | shipping_code_keyword | å¤æ‚æ™ºèƒ½åŒ¹é… | ä¸‰å±‚åŒ¹é… |
| é‡‡è´­äººå‘˜ | Text + Keyword | purchaser_keyword | å¤æ‚æ™ºèƒ½åŒ¹é… | ä¸‰å±‚åŒ¹é… |
| ä¾›åº”å•† | Text + Keyword | supplier_keyword | å¤æ‚æ™ºèƒ½åŒ¹é… | ä¸‰å±‚åŒ¹é… |
| åˆ›å»ºäººå‘˜ | Text + Keyword | creator_keyword | å¤æ‚æ™ºèƒ½åŒ¹é… | ä¸‰å±‚åŒ¹é… |

### 3. ESDOå±‚ä¼˜åŒ–

#### 3.1 å­—æ®µå®šä¹‰å®Œå–„

ç¡®ä¿æ‰€æœ‰æœç´¢å­—æ®µéƒ½æœ‰å¯¹åº”çš„keywordå­—æ®µï¼š

```java
// ç»„å“ç¼–å·
@Field(name = "no", type = FieldType.Keyword)
private String no;
@Field(name = "no_keyword", type = FieldType.Keyword)
private String noKeyword;

// äº§å“åç§°
@Field(name = "name", type = FieldType.Text, analyzer = "ik_max_word")
private String name;
@Field(name = "name_keyword", type = FieldType.Keyword)
private String nameKeyword;

// äº§å“ç®€ç§°
@Field(name = "short_name", type = FieldType.Text, analyzer = "ik_smart")
private String shortName;
@Field(name = "short_name_keyword", type = FieldType.Keyword)
private String shortNameKeyword;

// å‘è´§ç¼–ç 
@Field(name = "shipping_code", type = FieldType.Keyword)
private String shippingCode;
@Field(name = "shipping_code_keyword", type = FieldType.Keyword)
private String shippingCodeKeyword;

// é‡‡è´­äººå‘˜
@Field(name = "purchaser", type = FieldType.Text, analyzer = "ik_max_word")
private String purchaser;
@Field(name = "purchaser_keyword", type = FieldType.Keyword)
private String purchaserKeyword;

// ä¾›åº”å•†
@Field(name = "supplier", type = FieldType.Text, analyzer = "ik_max_word")
private String supplier;
@Field(name = "supplier_keyword", type = FieldType.Keyword)
private String supplierKeyword;

// åˆ›å»ºäººå‘˜
@Field(name = "creator", type = FieldType.Text, analyzer = "ik_max_word")
private String creator;
@Field(name = "creator_keyword", type = FieldType.Keyword)
private String creatorKeyword;

// ç”¨äºåç§°å”¯ä¸€æ€§æ ¡éªŒçš„æ ‡å‡†åŒ–å­—æ®µ
@Field(type = FieldType.Keyword)
private String normalizedName;
```

#### 3.2 è½¬æ¢æ–¹æ³•ä¼˜åŒ–

åœ¨`convertComboToES`æ–¹æ³•ä¸­ç¡®ä¿æ‰€æœ‰keywordå­—æ®µæ­£ç¡®è®¾ç½®ï¼š

```java
// è®¾ç½®keywordå­—æ®µï¼ˆç”¨äºç²¾ç¡®åŒ¹é…å’Œé€šé…ç¬¦æŸ¥è¯¢ï¼‰
es.setNoKeyword(combo.getNo());
es.setShortNameKeyword(combo.getShortName());
es.setShippingCodeKeyword(combo.getShippingCode());
es.setPurchaserKeyword(combo.getPurchaser());
es.setSupplierKeyword(combo.getSupplier());
es.setCreatorKeyword(combo.getCreator());

// è®¾ç½®normalizedNameç”¨äºå”¯ä¸€æ€§æ ¡éªŒ
es.setNormalizedName(normalizeComboName(fullComboName));
```

#### 3.3 åç§°æ ‡å‡†åŒ–å¤„ç†

æ–°å¢`normalizeComboName`æ–¹æ³•ï¼Œç”¨äºç»„åˆäº§å“åç§°çš„å”¯ä¸€æ€§æ ¡éªŒï¼š

```java
/**
 * æ ‡å‡†åŒ–ç»„åˆäº§å“åç§°ï¼Œç”¨äºå”¯ä¸€æ€§æ ¡éªŒ
 * ç§»é™¤ç©ºæ ¼ã€è½¬æ¢ä¸ºå°å†™ã€æ’åºå•å“åç§°ç­‰
 */
private String normalizeComboName(String comboName) {
    if (StrUtil.isBlank(comboName)) {
        return "";
    }

    try {
        // è§£æç»„åˆåç§°ï¼Œæå–å•å“å’Œæ•°é‡
        Map<String, Integer> nameMap = extractNameMap(comboName);
        
        // æŒ‰å•å“åç§°æ’åºï¼Œç¡®ä¿ç›¸åŒç»„åˆçš„ä¸åŒé¡ºåºè¢«è§†ä¸ºç›¸åŒ
        List<String> sortedItems = nameMap.entrySet().stream()
                .sorted(Map.Entry.comparingByKey())
                .map(entry -> entry.getKey() + "Ã—" + entry.getValue())
                .collect(Collectors.toList());
        
        // é‡æ–°ç»„åˆä¸ºæ ‡å‡†æ ¼å¼
        return String.join("+", sortedItems);
    } catch (Exception e) {
        // å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›åŸåç§°çš„æ ‡å‡†åŒ–ç‰ˆæœ¬
        return comboName.trim().toLowerCase().replaceAll("\\s+", "");
    }
}
```

### 4. ä»£ç ç®€åŒ–æ•ˆæœ

#### 4.1 ä¼˜åŒ–å‰ï¼ˆå¤æ‚æ™ºèƒ½åŒ¹é…ï¼‰
```java
// æ¯ä¸ªå­—æ®µéœ€è¦50+è¡Œä»£ç 
if (StringUtils.isNotBlank(pageReqVO.getName())) {
    BoolQueryBuilder nameQuery = QueryBuilders.boolQuery();
    String name = pageReqVO.getName().trim();
    
    // å¤æ‚çš„æ™ºèƒ½åŒ¹é…é€»è¾‘
    BoolQueryBuilder multiMatchQuery = QueryBuilders.boolQuery();
    
    // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šå®Œå…¨ç²¾ç¡®åŒ¹é…
    multiMatchQuery.should(QueryBuilders.termQuery("name_keyword", name).boost(1000000.0f));
    
    // ç¬¬äºŒä¼˜å…ˆçº§ï¼šå‰ç¼€åŒ¹é…
    multiMatchQuery.should(QueryBuilders.prefixQuery("name_keyword", name).boost(100000.0f));
    
    // ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šåŒ…å«åŒ¹é…
    multiMatchQuery.should(QueryBuilders.wildcardQuery("name_keyword", "*" + name + "*").boost(50000.0f));
    
    // ç¬¬å››ä¼˜å…ˆçº§ï¼šæ™ºèƒ½åˆ†è¯åŒ¹é…
    multiMatchQuery.should(createIntelligentMatchQuery("name", name, 800.0f, 600.0f, 500.0f));
    
    // ç¬¬äº”ä¼˜å…ˆçº§ï¼šå­å­—ç¬¦ä¸²åŒ¹é…
    if (name.length() >= 2) {
        for (int i = 1; i < name.length(); i++) {
            String substring = name.substring(i);
            if (substring.length() >= 2) {
                multiMatchQuery.should(QueryBuilders.wildcardQuery("name_keyword", "*" + substring + "*").boost(3000.0f));
            }
        }
    }
    
    multiMatchQuery.minimumShouldMatch(1);
    nameQuery.must(multiMatchQuery);
    boolQuery.must(nameQuery);
}
```

#### 4.2 ä¼˜åŒ–åï¼ˆç®€åŒ–ä¸‰å±‚åŒ¹é…ï¼‰
```java
// æ¯ä¸ªå­—æ®µåªéœ€è¦10è¡Œä»£ç 
if (StringUtils.isNotBlank(pageReqVO.getName())) {
    BoolQueryBuilder nameQuery = QueryBuilders.boolQuery();
    String name = pageReqVO.getName().trim();

    BoolQueryBuilder multiMatchQuery = QueryBuilders.boolQuery();

    // ğŸ”¥ ç®€åŒ–çš„åç§°åŒ¹é…ç­–ç•¥ï¼šä¸ç»„å“ç¼–å·ä¿æŒä¸€è‡´
    // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šå®Œå…¨ç²¾ç¡®åŒ¹é…ï¼ˆæœ€é«˜æƒé‡ï¼‰
    multiMatchQuery.should(QueryBuilders.termQuery("name_keyword", name).boost(1000000.0f));

    // ç¬¬äºŒä¼˜å…ˆçº§ï¼šå‰ç¼€åŒ¹é…
    multiMatchQuery.should(QueryBuilders.prefixQuery("name_keyword", name).boost(100000.0f));

    // ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šåŒ…å«åŒ¹é…ï¼ˆæ”¯æŒä»»æ„ä½ç½®çš„æ¨¡ç³ŠåŒ¹é…ï¼‰
    multiMatchQuery.should(QueryBuilders.wildcardQuery("name_keyword", "*" + name + "*").boost(50000.0f));

    multiMatchQuery.minimumShouldMatch(1);
    nameQuery.must(multiMatchQuery);
    boolQuery.must(nameQuery);
}
```

## ä¼˜åŒ–æ•ˆæœ

### 1. æ€§èƒ½æå‡
- **æŸ¥è¯¢å¤æ‚åº¦é™ä½**ï¼šä»5å±‚åŒ¹é…å‡å°‘åˆ°3å±‚åŒ¹é…
- **ä»£ç æ‰§è¡Œæ•ˆç‡**ï¼šç§»é™¤å¤æ‚çš„æ™ºèƒ½åˆ†è¯å’Œå­å­—ç¬¦ä¸²å¤„ç†
- **ESæŸ¥è¯¢æ€§èƒ½**ï¼šå‡å°‘ä¸å¿…è¦çš„æŸ¥è¯¢æ¡ä»¶

### 2. ç»´æŠ¤æ€§æå‡
- **ä»£ç ç»Ÿä¸€æ€§**ï¼šæ‰€æœ‰å­—æ®µä½¿ç”¨ç›¸åŒçš„æœç´¢ç­–ç•¥
- **é€»è¾‘ç®€åŒ–**ï¼šæ¯ä¸ªå­—æ®µçš„æœç´¢é€»è¾‘ä»50+è¡Œå‡å°‘åˆ°10è¡Œ
- **æ˜“äºç†è§£**ï¼šä¸‰å±‚åŒ¹é…ç­–ç•¥æ¸…æ™°æ˜äº†

### 3. åŠŸèƒ½ä¿æŒ
- **ç²¾ç¡®æŸ¥è¯¢**ï¼šé€šè¿‡termQueryå®ç°å®Œå…¨ç²¾ç¡®åŒ¹é…
- **æ¨¡ç³ŠæŸ¥è¯¢**ï¼šé€šè¿‡prefixQueryå’ŒwildcardQueryå®ç°æ¨¡ç³ŠåŒ¹é…
- **æƒé‡æ’åº**ï¼šä¿æŒåˆç†çš„æƒé‡åˆ†é…ï¼Œç¡®ä¿ç»“æœå‡†ç¡®æ€§

## å®æ–½æ­¥éª¤

1. **ESDOå±‚ä¿®æ”¹**ï¼šç¡®ä¿æ‰€æœ‰æœç´¢å­—æ®µéƒ½æœ‰å¯¹åº”çš„keywordå­—æ®µ
2. **è½¬æ¢æ–¹æ³•ä¼˜åŒ–**ï¼šåœ¨convertComboToESä¸­æ­£ç¡®è®¾ç½®keywordå­—æ®µ
3. **æœç´¢ç­–ç•¥ç»Ÿä¸€**ï¼šå°†æ‰€æœ‰å­—æ®µçš„æœç´¢é€»è¾‘æ”¹ä¸ºä¸‰å±‚åŒ¹é…
4. **æµ‹è¯•éªŒè¯**ï¼šç¡®ä¿æœç´¢åŠŸèƒ½æ­£å¸¸ï¼Œæ€§èƒ½æœ‰æ‰€æå‡

## æ³¨æ„äº‹é¡¹

1. **ç´¢å¼•é‡å»º**ï¼šå¦‚æœESDOç»“æ„æœ‰å˜åŒ–ï¼Œéœ€è¦é‡å»ºESç´¢å¼•
2. **æ•°æ®åŒæ­¥**ï¼šç¡®ä¿ç°æœ‰æ•°æ®çš„keywordå­—æ®µæ­£ç¡®è®¾ç½®
3. **å‘åå…¼å®¹**ï¼šä¿æŒAPIæ¥å£çš„å‘åå…¼å®¹æ€§
4. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§ä¼˜åŒ–åçš„æœç´¢æ€§èƒ½è¡¨ç°

## æœç´¢ç¤ºä¾‹

### ç»„å“ç¼–å·æœç´¢
```
è¾“å…¥: "CP2025"
åŒ¹é…: 
- ç²¾ç¡®åŒ¹é…: "CP2025" (æƒé‡1,000,000)
- å‰ç¼€åŒ¹é…: "CP2025..." (æƒé‡100,000)
- åŒ…å«åŒ¹é…: "...CP2025..." (æƒé‡50,000)
```

### äº§å“åç§°æœç´¢
```
è¾“å…¥: "å˜è‰²å£çº¢"
åŒ¹é…:
- ç²¾ç¡®åŒ¹é…: "å˜è‰²å£çº¢" (æƒé‡1,000,000)
- å‰ç¼€åŒ¹é…: "å˜è‰²å£çº¢..." (æƒé‡100,000)
- åŒ…å«åŒ¹é…: "...å˜è‰²å£çº¢..." (æƒé‡50,000)
```

### é‡‡è´­äººå‘˜æœç´¢
```
è¾“å…¥: "å¼ ä¸‰"
åŒ¹é…:
- ç²¾ç¡®åŒ¹é…: "å¼ ä¸‰" (æƒé‡1,000,000)
- å‰ç¼€åŒ¹é…: "å¼ ä¸‰..." (æƒé‡100,000)
- åŒ…å«åŒ¹é…: "...å¼ ä¸‰..." (æƒé‡50,000)
```

## æ³¨æ„äº‹é¡¹

1. **ESç´¢å¼•ç»“æ„**ï¼šç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æœ‰å¯¹åº”çš„keywordå­—æ®µç”¨äºç²¾ç¡®åŒ¹é…
2. **æƒé‡é…ç½®**ï¼šæƒé‡å€¼å¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚è°ƒæ•´
3. **æµ‹è¯•éªŒè¯**ï¼šä¼˜åŒ–åéœ€è¦å…¨é¢æµ‹è¯•å„ç§æœç´¢åœºæ™¯
4. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§æœç´¢æ€§èƒ½ï¼Œç¡®ä¿ä¼˜åŒ–æ•ˆæœ

## åç»­ä¼˜åŒ–å»ºè®®

1. **æƒé‡è°ƒä¼˜**ï¼šæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´å„å±‚çº§çš„æƒé‡å€¼
2. **ç¼“å­˜ç­–ç•¥**ï¼šå¯¹å¸¸ç”¨æœç´¢æ¡ä»¶æ·»åŠ ç¼“å­˜
3. **æœç´¢å»ºè®®**ï¼šè€ƒè™‘æ·»åŠ æœç´¢å»ºè®®åŠŸèƒ½
4. **é«˜çº§æœç´¢**ï¼šæ”¯æŒå¤šå­—æ®µç»„åˆæœç´¢ 